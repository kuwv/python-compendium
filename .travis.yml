---
language: python
cache: pip
# python:
#   - "3.6"
#   - "3.7"
#   - "3.8"

stages:
  - test
  - name: deploy
    if: tag IS present
  - coverage

before_install:
  - pip uninstall pipenv numpy -y
  - pip install poetry

install:
  - poetry install

jobs:
  fast_finish: true
  include:
    - stage: test
      script: inv format --check
    - script: inv lint
    - script: inv unit-test
    - script: inv safety

    - stage: deploy
      script: skip
      before_deploy:
        - poetry build
      deploy:
        provider: pypi
        user: __token__
        password: $PYPI_TOKEN
        distributions: dist
        skip_existing: true
        on:
          tags: true
          branch: master

    - stage: coverage
      script:
        - inv coverage --report=xml
        - bash <(curl -s https://codecov.io/bash)
